<app-org-dashboard-navbar></app-org-dashboard-navbar>

<div class="container-fluid vp-payment-container">
  <div class="row">
    <div class="col-12">
      <!-- Header Section -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-info text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">
              <i class="fas fa-file-invoice-dollar me-2"></i>
              Vendor Payments
            </h4>
            <div class="btn-group">
              <button class="btn btn-light btn-sm" routerLink="/org-dashboard/vendor-payments">
                <i class="fas fa-arrow-left me-2"></i>
                Back to Vendor Payments
              </button>
              <button class="btn btn-light btn-sm" (click)="refreshPayments()">
                <i class="fas fa-sync-alt me-2" [class.fa-spin]="isLoading"></i>
                Refresh
              </button>
            </div>
          </div>
        </div>
        
        <!-- Filters and Controls -->
        <div class="card-body">
          <!-- Status Filter -->
          <div class="row mb-4">
            <div class="col-md-4">
              <label for="statusFilter" class="form-label">
                <strong>Filter by Status:</strong>
              </label>
              <select 
                id="statusFilter" 
                class="form-select" 
                [(ngModel)]="selectedStatus" 
                (change)="onStatusFilterChange()">
                <option *ngFor="let option of statusOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>
            
            <div class="col-md-4">
              <div class="d-flex align-items-end">
                <div class="w-100">
                  <label for="pageSize" class="form-label">Show:</label>
                  <select 
                    id="pageSize" 
                    class="form-select" 
                    [(ngModel)]="pageSize" 
                    (change)="onPageSizeChange()">
                    <option *ngFor="let size of pageSizes" [value]="size">{{ size }}</option>
                  </select>
                </div>
                <span class="ms-2 text-muted">entries</span>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="d-flex align-items-end justify-content-end">
                <small class="text-muted">
                  Total: {{ totalElements }} payments
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Success Message -->
      <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        {{ successMessage }}
        <button type="button" class="btn-close" (click)="successMessage = ''" aria-label="Close"></button>
      </div>

      <!-- Error Message -->
      <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ errorMessage }}
        <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
      </div>

      <!-- Loading Spinner -->
      <div *ngIf="isLoading" class="text-center py-5">
        <div class="spinner-border text-info" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading payments...</p>
      </div>

      <!-- Payments Table -->
      <div *ngIf="!isLoading && payments.length > 0" class="card shadow-sm border-0">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle">
              <thead class="table-info">
                <tr>
                  <th scope="col" class="text-center" style="width: 10%;">Payment ID</th>
                  <th scope="col" class="text-center"style="width: 25%;">Vendor</th>
                  <th scope="col" class="text-center" style="width: 15%;">Amount</th>
                  <th scope="col" class="text-center" style="width: 12%;">Status</th>
                  <th scope="col" class="text-center" style="width: 10%;">Request ID</th>
                  <th scope="col" class="text-center" style="width: 28%;">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let payment of payments; let i = index" 
                    class="payment-row">
                  <td class="fw-bold text-center">{{ payment.vpId }}</td>
                  <td>
                    <div class="vendor-info">
                      <div class="fw-medium text-center">{{ payment.vendorName }}</div>
                      <small class="text-muted text-center">ID: {{ payment.vendorId }}</small>
                    </div>
                  </td>
                  <td class="text-center">
                    <span class="amount-display">
                      â‚¹{{ payment.amount | number:'1.2-2' }}
                    </span>
                  </td>
                  <td class="text-center">
                    <span [class]="getStatusBadgeClass(payment.status)">
                      {{ payment.status.replace('_', ' ') }}
                    </span>
                  </td>
                  <td class="text-center">
                    <span *ngIf="payment.requestId" class="fw-medium">
                      {{ payment.requestId }}
                    </span>
                    <span *ngIf="!payment.requestId" class="text-muted">
                      --
                    </span>
                  </td>
                  <td class="text-center">
                    <div class="d-flex flex-column flex-md-row gap-1 justify-content-center" role="group">
                      <!-- Send Request Button -->
                      <button 
                        type="button" 
                        class="btn btn-warning btn-sm"
                        title="Send Request"
                        [disabled]="!canSendRequest(payment) || isProcessing(payment.vpId)"
                        (click)="sendRequest(payment)">
                        <i class="fas fa-paper-plane me-1" [class.fa-spin]="isProcessing(payment.vpId)"></i>
                        <span class="d-none d-lg-inline">{{ isProcessing(payment.vpId) ? 'Processing...' : 'Send Request' }}</span>
                        <span class="d-lg-none">{{ isProcessing(payment.vpId) ? 'Processing...' : 'Send' }}</span>
                      </button>
                      
                      <!-- Edit Button -->
                      <button 
                        type="button" 
                        class="btn btn-primary btn-sm"
                        title="Edit Payment"
                        [disabled]="!canEdit(payment)"
                        (click)="editPayment(payment)">
                        <i class="fas fa-edit me-1"></i>
                        <span class="d-none d-lg-inline">Edit</span>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Empty State -->
          <div *ngIf="payments.length === 0 && !isLoading" class="text-center py-5">
            <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No payments found</h5>
            <p class="text-muted mb-3">
              {{ selectedStatus ? 'No payments found with the selected status.' : 'No vendor payments have been initiated yet.' }}
            </p>
            <button *ngIf="selectedStatus" class="btn btn-outline-info" (click)="selectedStatus = ''; onStatusFilterChange()">
              <i class="fas fa-filter me-2"></i>
              Clear Filter
            </button>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div *ngIf="showPagination" class="d-flex justify-content-between align-items-center mt-4">
        <div class="pagination-info">
          <small class="text-muted">
            Showing {{ currentPage * pageSize + 1 }} to 
            {{ Math.min((currentPage + 1) * pageSize, totalElements) }} 
            of {{ totalElements }} entries
          </small>
        </div>

        <nav aria-label="Payment pagination">
          <ul class="pagination pagination-sm mb-0">
            <!-- First Page -->
            <li class="page-item" [class.disabled]="currentPage === 0">
              <button class="page-link" (click)="onPageChange(0)" [disabled]="currentPage === 0">
                <i class="fas fa-angle-double-left"></i>
              </button>
            </li>
            
            <!-- Previous Page -->
            <li class="page-item" [class.disabled]="currentPage === 0">
              <button class="page-link" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 0">
                <i class="fas fa-angle-left"></i>
              </button>
            </li>

            <!-- Page Numbers -->
            <li *ngFor="let page of getPageNumbers()" 
                class="page-item" 
                [class.active]="page === currentPage">
              <button class="page-link" (click)="onPageChange(page)">
                {{ page + 1 }}
              </button>
            </li>

            <!-- Next Page -->
            <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
              <button class="page-link" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages - 1">
                <i class="fas fa-angle-right"></i>
              </button>
            </li>
            
            <!-- Last Page -->
            <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
              <button class="page-link" (click)="onPageChange(totalPages - 1)" [disabled]="currentPage === totalPages - 1">
                <i class="fas fa-angle-double-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>

<!-- Edit Payment Modal -->
<div class="modal fade" 
     [class.show]="showEditModal" 
     [style.display]="showEditModal ? 'block' : 'none'"
     tabindex="-1" 
     role="dialog" 
     aria-labelledby="editPaymentModalLabel" 
     aria-hidden="true"
     *ngIf="showEditModal">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editPaymentModalLabel">
          <i class="fas fa-edit me-2"></i>
          Edit Payment Amount
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeEditModal()" aria-label="Close"></button>
      </div>
      
      <div class="modal-body">
        <div *ngIf="editingPayment" class="mb-3">
          <div class="alert alert-info">
            <strong>Payment Details:</strong><br>
            <strong>Payment ID:</strong> {{ editingPayment.vpId }}<br>
            <strong>Vendor:</strong> {{ editingPayment.vendorName }}<br>
            <strong>Current Amount:</strong> ${{ editingPayment.amount | number:'1.2-2' }}<br>
            <strong>Status:</strong> 
            <span [class]="getStatusBadgeClass(editingPayment.status)">{{ editingPayment.status }}</span>
          </div>
        </div>

        <!-- Error Message -->
        <div *ngIf="editErrorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>
          {{ editErrorMessage }}
          <button type="button" class="btn-close" (click)="editErrorMessage = ''" aria-label="Close"></button>
        </div>

        <form (submit)="submitEditPayment()" #editForm="ngForm">
          <div class="mb-3">
            <label for="editAmount" class="form-label">
              <strong>New Payment Amount ($):</strong>
            </label>
            <input 
              type="number" 
              id="editAmount"
              name="editAmount"
              class="form-control form-control-lg" 
              [(ngModel)]="editAmount"
              min="0.01"
              step="0.01"
              required
              placeholder="Enter new amount"
              [disabled]="isUpdatingPayment">
            <div class="form-text">
              Enter the corrected payment amount for this rejected payment.
            </div>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()" [disabled]="isUpdatingPayment">
          <i class="fas fa-times me-2"></i>
          Cancel
        </button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="submitEditPayment()"
          [disabled]="isUpdatingPayment || editAmount <= 0">
          <span *ngIf="isUpdatingPayment" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          <i *ngIf="!isUpdatingPayment" class="fas fa-save me-2"></i>
          {{ isUpdatingPayment ? 'Updating...' : 'Update Payment' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade" [class.show]="showEditModal" *ngIf="showEditModal" (click)="closeEditModal()"></div>
